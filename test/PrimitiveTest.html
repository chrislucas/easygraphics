<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Primitive Test</title>
    <script src="../build/js/easygraphics.js"></script>

    <style>
        #svg {
            border: 1px solid #000;
        }

    </style>

    <style>
        @import url('https://fonts.googleapis.com/css?family=Roboto');
    </style>

</head>
<body>

<svg id="svg" width="1024" height="768"></svg>

<script>

    var rect;
    var text;
    var umlClass;
    var node;
	var umlUseCase;
	var ellipse;
	var circle1;
	var ellipse1;
	
    (function () {
        let svgArea = new easygraphics.Area.init("#svg");
		
        //****************************
		// Code to move elements using drag-and-drop.
		let selectedElement = null;
		let relativeXPosition = -1;
		let relativeYPosition = -1;
		function select(x, y, element, event) { 
			if(element instanceof easygraphics.GraphicalElement) {
				selectedElement = element;
				relativeXPosition = x - element.x;
				relativeYPosition = y - element.y;
				event.stopPropagation();
			} else {
				selectedElement = null;
			}
		}
		function move(x, y, element) {
			if(selectedElement !== null) {
				selectedElement.x = x - relativeXPosition;
				selectedElement.y = y - relativeYPosition;
				/*if(selectedElement.getTag(easygraphics.BoxVerticesDecorator.BOX_VERTICES_TAG)) {
					console.log(selectedElement.getTag(easygraphics.BoxVerticesDecorator.BOX_VERTICES_TAG).x);
				}*/
			}
		}
		function unselect(x, y, element) { 
			selectedElement = null;
			relativeXPosition = -1;
			relativeYPosition = -1;
		}
		svgArea.onMouseDown = select;
		svgArea.onMouseMove = move;
		svgArea.onMouseUp = unselect;
		//****************************
		
        //****************************
        // UML Entity Class.
    /*    rect = svgArea.rect()
        umlClass = svgArea.vgroup(10, 10);
        umlClass.frame = rect;
        let stereotype = svgArea.text(undefined, undefined, "<<Entity>>");
        stereotype.fontStylingAttributes.style = "italic";
        umlClass.addChild(stereotype, easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        umlClass.addChild(svgArea.text(undefined, undefined, "<<< TRY TO MODE ME >>>"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        umlClass.addChild(svgArea.line(), easygraphics.VerticalGroup.MATCH_PARENT);
		let attribute = svgArea.text(undefined, undefined, "<<< TRY DO EDIT ME: String >>>");
        umlClass.addChild(attribute);

		// Editable attribute.
		attribute.onDblClick = function(x, y, element, event) {
			defaultTextEditor(x, y, element);
			event.stopPropagation();
		}
		
        umlClass.addChild(svgArea.text(undefined, undefined, "- name: String"));
        umlClass.addChild(svgArea.text(undefined, undefined, "- birthDate: Date"));
        umlClass.addChild(svgArea.line(), easygraphics.VerticalGroup.MATCH_PARENT);
        umlClass.addChild(svgArea.text(undefined, undefined, "+ save(): void"));
        umlClass.addChild(svgArea.text(undefined, undefined, "+ update(): void"));
        text = svgArea.text(undefined, undefined, "+ findByRegistry(registry: String): List<Customer>");
        umlClass.addChild(text);
		
		// Drag and drop.
		umlClass.onMouseDown = select;
		umlClass.onMouseMove = move;
		umlClass.onMouseUp = unselect;		*/
        //****************************
/*
        //****************************
        // UML Actor.
        let umlActor = svgArea.vgroup(10, 300);
        umlActor.addChild(svgArea.image(undefined, undefined, 25, 50, "images/uml_actor.svg"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        umlActor.addChild(svgArea.text(undefined, undefined, "Actor"));
        //****************************

        //****************************
        // UML Use Case.
        umlUseCase = svgArea.vgroup(160, 320);
        umlUseCase.frame = svgArea.ellipse();
        let uctext = svgArea.text(undefined, undefined, "U.C.");
        umlUseCase.addChild(uctext, easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        //****************************

        //****************************
        // UML Use Case.
        let umlUseCase1 = svgArea.vgroup(300, 320, new easygraphics.GroupStylingAttributes(0, 0));
        umlUseCase1.frame = svgArea.ellipse();
        umlUseCase1.addChild(svgArea.text(undefined, undefined, "Other Use Case"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        let line = svgArea.line();
        umlUseCase1.addChild(line, easygraphics.VerticalGroup.MATCH_PARENT);
        umlUseCase1.addChild(svgArea.text(undefined, undefined, "extension points", new easygraphics.FontStylingAttributes(family = "'Roboto', sans-serif", size = 13, weight = "500", style = "normal", target = null)), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        umlUseCase1.addChild(svgArea.text(undefined, undefined, "Another use case"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        umlUseCase1.addChild(svgArea.text(undefined, undefined, "Yet another use case"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
		umlUseCase1.addChild(svgArea.text(undefined, undefined, "=============="), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
		umlUseCase1.addChild(svgArea.text(undefined, undefined, ">>> TRY TO MOVE ME <<<"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
		
		// Drag and drop.
		umlUseCase1.onMouseDown = select;
		umlUseCase1.onMouseMove = move;
		umlUseCase1.onMouseUp = unselect;
        //****************************
		
		svgArea.polyLine(new easygraphics.StylingAttributes(1, "#00F", "none"), 50, 560, 100, 550, 200, 600);
	*/
	
		ellipse = svgArea.ellipse(200, 100, 50, 25);
		
		// This works.
		/*ellipse.onMouseDown = select;
		ellipse.onMouseMove = move;
		ellipse.onMouseUp = unselect;*/
		
		// But when the ellipse is put inside a decorator, moving is not working anymore.
		let decorator = svgArea.boxVerticesDecorator(ellipse);
		decorator.onMouseDown = select;
		decorator.onMouseMove = move;
		decorator.onMouseUp = unselect;
		decorator.onVertexMouseDown = select;
		decorator.width += 200;
		
		//decorator.x += 50;
		
        //****************************
        // Graph node.
/*        node = svgArea.vgroup(340, 50);
        node.frame = svgArea.circle();
        let text1 = svgArea.text(undefined, undefined, "Graph Node");
        node.addChild(text1, easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);*/
        /*
         node.addChild(svgArea.line(), easygraphics.VerticalGroup.MATCH_PARENT);
         node.addChild(svgArea.text(undefined, undefined, "2nd row"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
         node.addChild(svgArea.text(undefined, undefined, "3rd row"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
         */
        //****************************

        //****************************
        // UML decision node.
        /*let decisionNode = svgArea.vgroup(450, 450);
        decisionNode.frame = svgArea.diamond(undefined, undefined, undefined, undefined, true);
        decisionNode.addChild(svgArea.text(undefined, undefined, "Condition"), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER);
        //****************************

        //****************************
        // Vertical group with weight.
        let vgroupWeight = svgArea.vgroup(650, 450, new easygraphics.GroupStylingAttributes(0, 0));
        vgroupWeight.addChild(svgArea.line(10, 10, 10, 100, new easygraphics.StylingAttributes(3)), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER, 1);
        vgroupWeight.addChild(svgArea.diamond(undefined, undefined, 20, 20), easygraphics.VerticalGroup.WRAP_CONTENT, easygraphics.VerticalGroup.CENTER, 0, -2);
        vgroupWeight.rotation = 45;
        //****************************
*/
        //console.log(angleBetween2Lines(50, 0, 50, 100, 0, 100, 100, 0));
        //console.log(angleBetween2Lines(50, 0, 50, 100, 0, 0, 100, 100));*/
		
    })();

	function randomText() {
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

		for (var i = 0; i < 1 + Math.random() * 100; i++)
			text += possible.charAt(Math.floor(Math.random() * possible.length));

		return text;
    }

	//****************************
	// Code to edit a class attribute when it is double clicked.
	function defaultTextEditor(x, y, element) {
		var box = document.createElement('input'); // creates the element

		box.style.position = 'absolute';  // position it
		box.style.left = element.x + 'px';
		box.style.top = element.y + 'px';  
		box.value = element.text;
		
		document.body.appendChild(box); // add it as last child of body elemnt
		box.focus();
		box.onkeypress = function(e){
			if (!e) e = window.event;
			var keyCode = e.keyCode || e.which;
			if (keyCode == '13'){
			  box.blur();
			  return false;
			}
		  }

		box.onblur = function() {
			element.text = box.value;
			document.body.removeChild(box);
		}		
	}
	//****************************

    function changeDimensions() {
        if (ellipse1.width > 400) {
            ellipse1.width -= 50;
        } else {
            ellipse1.width += 10;
        }
    }

    function move() {
        if (umlClass.x > 200) {
            umlClass.x -= 50;
        } else {
            umlClass.x += 10;
        }
    }

    function changeStyle() {
        rect.appearance({
            fill: "none",
            stroke: "red",
            strokeWidth: 2
        });
    }

    function changeText() {
        text.text = randomText();
    }

    function fitContent() {
        umlClass.forceFitContent();
    }

	
/*		let draggingDecorator = false
		let initialX = 0;
		let initialY = 0;
		let initialWidth = 0;
		let initialHeight = 0;
		decorator.onVertexMouseDown = function(x, y, where) { 
			initialX = x;
			initialY = y;
			initialWidth = decorator.width;
			initialHeight = decorator.height;
			draggingDecorator = true;
			console.log('down');
		};
		decorator.onVertexMouseMove = function(x, y, where) { 
			if(draggingDecorator) {
				console.log(where.tag);
				if(where.tag === easygraphics.BoxVerticesDecorator.BOTTOM_RIGHT) {
					let newWidth = initialWidth + (x - initialX);
					let newHeight = initialHeight + (y - initialY);
					if(newWidth > 0 && newHeight > 0) {
						ellipse.width += 50;
						//ellipse.height = initialHeight * 2;
						console.log('chaging width to ' + ellipse.width + " - " + newWidth);
					}
				}
				
			}
		};
		decorator.onVertexMouseUp = function(x, y, where) { 
			initialX = 0;
			initialY = 0;
			draggingDecorator = false;
			console.log('up');
		};*/
		
</script>

<button type="button" onclick="changeDimensions()">Change dimensions</button>
<button type="button" onclick="move()">Move</button>
<button type="button" onclick="changeStyle()">Change style</button>
<button type="button" onclick="changeText()">Change text</button>
<button type="button" onclick="fitContent()">Fit content</button>

</body>
</html>